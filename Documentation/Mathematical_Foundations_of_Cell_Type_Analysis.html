<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mathematical Foundations of Cell Type Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --dark: #212529;
            --light: #f8f9fa;
            --bg-gradient: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            --card-bg: #ffffff;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            color: var(--dark);
            line-height: 1.5;
            background: var(--bg-gradient);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1, h2, h3 {
            color: var(--secondary);
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        
        h1 {
            text-align: center;
            font-size: 2.2em;
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(67, 97, 238, 0.2);
        }
        
        h2 {
            font-size: 1.6em;
            border-bottom: 1px solid rgba(67, 97, 238, 0.2);
            padding-bottom: 5px;
        }
        
        h3 {
            font-size: 1.3em;
            color: var(--primary);
        }
        
        .section {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
        }
        
        .formula {
            background-color: rgba(248, 249, 250, 0.7);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .formula-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
            font-size: 0.9em;
        }
        
        .algorithm {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 3px solid var(--accent);
        }
        
        .note {
            background-color: #e6f7ff;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 3px solid var(--success);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .section {
                padding: 15px;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Mathematical Foundations of Cell Type Analysis</h1>
        
        <!-- Vision Transformer Section -->
        <div class="section">
            <h2>1. Vision Transformer Architecture</h2>
            
            <h3>1.1 Input Image Processing</h3>
            <div class="formula">
                <div class="formula-title">Input Image Representation</div>
                \[ I \in \mathbb{R}^{H \times W \times 3} \]
            </div>
            
            <h3>1.2 Patch Embedding</h3>
            <div class="formula">
                <div class="formula-title">Patch Partition</div>
                \[ \mathbf{P} = \text{PatchPartition}(I) \in \mathbb{R}^{N \times (p^2 \cdot 3)} \]
                Where \( p \) is the patch size (16 for ViT-Base) and \( N = \frac{HW}{p^2} \)
            </div>
            
            <div class="formula">
                <div class="formula-title">Embedding with Positional Encoding</div>
                \[ \mathbf{E}_0 = [\mathbf{x}_{\text{class}}; \mathbf{P}\mathbf{W}_p] + \mathbf{E}_{\text{pos}} \]
                Where \( \mathbf{W}_p \in \mathbb{R}^{(p^2 \cdot 3) \times d} \) is the projection matrix
            </div>
            
            <h3>1.3 Transformer Layers</h3>
            <div class="formula">
                <div class="formula-title">Multi-Head Attention</div>
                \[ \text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right)V \]
                \[ \text{MultiHead}(Q, K, V) = \text{Concat}(\text{head}_1, \ldots, \text{head}_h)W^O \]
            </div>
            
            <div class="formula">
                <div class="formula-title">Layer Normalization and Residual Connections</div>
                \[ \mathbf{Z}_l = \text{LayerNorm}(\mathbf{E}_{l-1}) \]
                \[ \mathbf{A}_l = \text{MultiHeadAttention}(\mathbf{Z}_l, \mathbf{Z}_l, \mathbf{Z}_l) \]
                \[ \mathbf{E}_l = \mathbf{A}_l + \mathbf{E}_{l-1} \]
            </div>
            
            <div class="formula">
                <div class="formula-title">MLP Block</div>
                \[ \mathbf{Z}'_l = \text{LayerNorm}(\mathbf{E}_l) \]
                \[ \mathbf{F}_l = \text{MLP}(\mathbf{Z}'_l) = \text{GELU}(\mathbf{Z}'_l W_1 + b_1)W_2 + b_2 \]
                \[ \mathbf{E}_l = \mathbf{F}_l + \mathbf{E}_l \]
            </div>
            
            <div class="formula">
                <div class="formula-title">Feature Extraction</div>
                \[ \phi(I) = \mathbf{E}_L[0] \in \mathbb{R}^d \]
                Where \( L \) is the number of layers and \( \mathbf{E}_L[0] \) is the class token
            </div>
        </div>
        
        <!-- Dimensionality Reduction Section -->
        <div class="section">
            <h2>2. Dimensionality Reduction</h2>
            
            <h3>2.1 UMAP (Uniform Manifold Approximation and Projection)</h3>
            <div class="formula">
                <div class="formula-title">Local Metric Computation</div>
                \[ \rho_i = \min_{j \neq i} d(\mathbf{x}_i, \mathbf{x}_j) \]
                \[ \sigma_i : \sum_{j \neq i} \exp\left(\frac{-\max(0, d_{ij} - \rho_i)}{\sigma_i}\right) = \log_2 k \]
                Where \( k \) is the number of nearest neighbors
            </div>
            
            <div class="formula">
                <div class="formula-title">Fuzzy Simplicial Set</div>
                \[ w_{ij} = \exp\left(\frac{-\max(0, d_{ij} - \rho_i)}{\sigma_i}\right) \]
            </div>
            
            <div class="formula">
                <div class="formula-title">Low-Dimensional Optimization</div>
                \[ \min_{\mathbf{y}} -\sum_{i \neq j} [w_{ij}\ln v_{ij} + (1-w_{ij})\ln(1-v_{ij})] \]
                \[ v_{ij} = (1 + a\|\mathbf{y}_i-\mathbf{y}_j\|_2^{2b})^{-1} \]
                With default parameters \( a=1.929, b=0.7915 \)
            </div>
            
            <h3>2.2 t-SNE (t-Distributed Stochastic Neighbor Embedding)</h3>
            <div class="formula">
                <div class="formula-title">High-Dimensional Probabilities</div>
                \[ p_{j|i} = \frac{\exp(-\|\mathbf{x}_i - \mathbf{x}_j\|^2 / 2\sigma_i^2)}{\sum_{k \neq i} \exp(-\|\mathbf{x}_i - \mathbf{x}_k\|^2 / 2\sigma_i^2)} \]
                \[ p_{ij} = \frac{p_{j|i} + p_{i|j}}{2N} \]
            </div>
            
            <div class="formula">
                <div class="formula-title">Low-Dimensional Probabilities</div>
                \[ q_{ij} = \frac{(1 + \|\mathbf{y}_i - \mathbf{y}_j\|^2)^{-1}}{\sum_{k \neq l} (1 + \|\mathbf{y}_k - \mathbf{y}_l\|^2)^{-1}} \]
            </div>
            
            <div class="formula">
                <div class="formula-title">KL Divergence Minimization</div>
                \[ C = KL(P\|Q) = \sum_{i \neq j} p_{ij} \log \frac{p_{ij}}{q_{ij}} \]
            </div>
        </div>
        
        <!-- Cluster Analysis Section -->
        <div class="section">
            <h2>3. Cluster Analysis</h2>
            
            <h3>3.1 K-Means Clustering</h3>
            <div class="formula">
                <div class="formula-title">Objective Function</div>
                \[ \min_{\{\mathcal{C}_j\}} \sum_{j=1}^k \sum_{\mathbf{y}_i \in \mathcal{C}_j} \|\mathbf{y}_i - \mathbf{\mu}_j\|_2^2 \]
                Where \( \mathcal{C}_j \) are clusters and \( \mathbf{\mu}_j \) are centroids
            </div>
            
            <div class="algorithm">
                <strong>K-Means Algorithm:</strong>
                <ol>
                    <li>Initialize centroids \( \mathbf{\mu}_1, \ldots, \mathbf{\mu}_k \) randomly</li>
                    <li>Assign each point to nearest centroid: \( \mathcal{C}_j = \{\mathbf{y}_i : \|\mathbf{y}_i - \mathbf{\mu}_j\| \leq \|\mathbf{y}_i - \mathbf{\mu}_l\| \forall l\} \)</li>
                    <li>Update centroids: \( \mathbf{\mu}_j = \frac{1}{|\mathcal{C}_j|} \sum_{\mathbf{y}_i \in \mathcal{C}_j} \mathbf{y}_i \)</li>
                    <li>Repeat until convergence</li>
                </ol>
            </div>
            
            <h3>3.2 Convex Hull Analysis</h3>
            <div class="formula">
                <div class="formula-title">Convex Hull Definition</div>
                \[ \text{Hull}(\mathcal{C}) = \left\{ \sum_{i=1}^{|\mathcal{C}|} \alpha_i \mathbf{y}_i \mid \mathbf{y}_i \in \mathcal{C}, \alpha_i \geq 0, \sum \alpha_i = 1 \right\} \]
            </div>
            
            <h3>3.3 Kernel Density Estimation</h3>
            <div class="formula">
                <div class="formula-title">Density Estimation</div>
                \[ \hat{f}_c(\mathbf{y}) = \frac{1}{|\mathcal{C}|h^2} \sum K\left(\frac{\|\mathbf{y}-\mathbf{y}_i\|_2}{h}\right) \]
                Using Gaussian kernel: \( K(u) = \frac{1}{\sqrt{2\pi}} e^{-\frac{1}{2}u^2} \)
            </div>
        </div>
        
        <!-- Prediction Models Section -->
        <div class="section">
            <h2>4. Prediction Models</h2>
            
            <h3>4.1 Gradient Boosting Regressor</h3>
            <div class="formula">
                <div class="formula-title">Model Definition</div>
                \[ F_M(\mathbf{x}) = \sum_{m=1}^M \gamma_m h_m(\mathbf{x}) \]
                Where \( h_m \) are weak learners (decision trees)
            </div>
            
            <div class="formula">
                <div class="formula-title">Loss Function</div>
                \[ \mathcal{L}(y, F) = \frac{1}{2}(y - F(\mathbf{x}))^2 \]
            </div>
            
            <div class="formula">
                <div class="formula-title">Multi-Output Extension</div>
                \[ \hat{\mathbf{y}} = [F_1(\mathbf{x}), \ldots, F_k(\mathbf{x})] \]
                For \( k \) cell types
            </div>
            
            <h3>4.2 Confidence Metrics</h3>
            <div class="formula">
                <div class="formula-title">Prediction Confidence</div>
                \[ \text{confidence} = \frac{\max(\mathbf{n})}{\|\mathbf{n}\|_1} \]
                Where \( \mathbf{n} \) is the normalized prediction vector
            </div>
            
            <div class="formula">
                <div class="formula-title">Similarity-Based Confidence</div>
                \[ \text{sim\_confidence} = \frac{\mathbf{p} \cdot \mathbf{s}}{\|\mathbf{p}\| \|\mathbf{s}\|} \]
                Where \( \mathbf{p} \) is predicted and \( \mathbf{s} \) is average similar sample
            </div>
            
            <div class="formula">
                <div class="formula-title">Selection Threshold</div>
                \[ \mathcal{S}_c = \{\mathbf{y}_i | \ell_i = c, \text{confidence}_i \geq \theta\} \]
                \[ \theta = \text{Quantile}_{1-\alpha}(\{\text{confidence}_i | \ell_i = c\}) \]
            </div>
        </div>
        
        <!-- Spatial Analysis Section -->
        <div class="section">
            <h2>5. Spatial Analysis</h2>
            
            <h3>5.1 Allen Brain Atlas Integration</h3>
            <div class="formula">
                <div class="formula-title">Coordinate Mapping</div>
                \[ \mathbf{\mu}_c = \text{median}(\{\mathbf{y}_i | \ell_i = c\}) \]
                \[ \mathbf{y}_i = [x_i, y_i, z_i] \text{ (CCF coordinates)} \]
            </div>
            
            <div class="formula">
                <div class="formula-title">Distance Matrix</div>
                \[ \mathbf{D} \in \mathbb{R}^{|\mathcal{C}| \times |\mathcal{C}|} \]
                \[ D_{ij} = \|\mathbf{\mu}_i - \mathbf{\mu}_j\|_2 \]
                \[ \mathbf{D}' = \frac{\mathbf{D} - \min(\mathbf{D})}{\max(\mathbf{D}) - \min(\mathbf{D})} \]
            </div>
            
            <h3>5.2 Boundary Detection</h3>
            <div class="formula">
                <div class="formula-title">Gradient-Based Boundaries</div>
                \[ \text{Boundary}(z) = \|\nabla \text{Annotation}(z)\|_0 \]
            </div>
        </div>
        
        <!-- Visualization Section -->
        <div class="section">
            <h2>6. Visualization Techniques</h2>
            
            <h3>6.1 Color Mapping</h3>
            <div class="formula">
                <div class="formula-title">Cell Type Coloring</div>
                \[ \text{color}_c = \mathbf{p}_c \in [0,1]^3 \]
                From tab20 colormap: \( \mathbf{p}_c = \text{cmap}(c \mod 20) \)
            </div>
            
            <h3>6.2 Thumbnail Embedding</h3>
            <div class="formula">
                <div class="formula-title">Image Representation</div>
                \[ \text{Thumbnail} = \text{Concat}(\text{Sagittal}, \text{Coronal}, \text{Axial}) \]
                Each view resized to \( 224 \times 224 \)
            </div>
            
        </div>
    </div>

    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['\\[', '\\]']],
                packages: {'[+]': ['mhchem']}
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreHtmlClass: 'tex2jax_ignore'
            },
            svg: {
                fontCache: 'global'
            },
            chtml: {
                scale: 0.95
            }
        };
    </script>
</body>
</html>